---
title: "HGDP clustering"
output: html_document
date: "2024-12-07"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## HGDP data set 

Here we use data from the Human Genome Diversity Project (HGDP)
https://www.internationalgenome.org/data-portal/data-collection/hgdpit to run 
through a full population genetic pipeline from raw data to population structure
analysis and visualisation, to create the plots seen in the Paper <>.

We downloaded the data from <???>

## Data preparation

Load necessary packages:
```{r}
# load packages 
library(tidypopgen)
library(fastmixturer)
library(readr)
```

Load the data into `gen_tibble` object:
```{r}
# path to PLINK
bed_path <- system.file("../inst/extdata/hgdp/hgdp_zhe_1_12-10-2024/hgdp650.qc.hg19.bed", package = "fastmixturer")

# load the data into gentibble using tidypopgen
hgdp_gt <- gen_tibble(bed_path, backingfile = tempfile()) 

# load the meta data
meta_info <- read_tsv(system.file("../inst/extdata/hgdp/hgdp_zhe_1_12-10-2024/HGDPid_populations.txt", package = "fastmixturer"))
```

Attach meta data to `gen_tibble`:
```{r}
# attach meta data to gentibble based on id 
hgdp_gt <- hgdp_gt %>% mutate(
  population = meta_info$population[match(hgdp_gt$id, meta_info$Id)],region = meta_info$Region[match(hgdp_gt$id, meta_info$Id)]
)
```

## Data preparation 

Remove more than 5% missing as suggested in ADMIXTURE manual:
```{r}
hgdp_gt <- hgdp_gt %>% select_loci_if(loci_missingness(genotypes)<0.05)
```

Remove monomorphic loci:
```{r}
hgdp_gt <- hgdp_gt %>% select_loci_if(loci_maf(genotypes)>0)
```

Update backing file:
```{r}
hgdp_ldprune_gt <- gt_update_backingfile(hgdp_ldprune_gt)
```


Impute any remaining missing values:
```{r}
# impute the data
hgdp_gt <- hgdp_gt %>% gt_impute_simple(method = "random")

# check
hgdp_gt %>% gt_has_imputed()
```

LD prune the data:
```{r}
# LD prune the data based on the threshold stated in ADMIXTURE manual "plink --bfile rawData --indep-pairwise 50 10 0.1"
hgdp_ldprune_gt <- hgdp_gt %>% select_loci_if(loci_ld_clump(genotypes, thr_r2 = 0.1, size = 50, use_positions = FALSE))

#check remaining
hgdp_gt %>% count_loci()
hgdp_ldprune_gt %>% count_loci()
```
```{r}
#update backing file 
hgdp_ldprune_gt <- gt_update_backingfile(hgdp_ldprune_gt)

# impute the data
hgdp_ldprune_gt <- hgdp_ldprune_gt %>% gt_impute_simple(method = "random")
```




Check data with PCA:
```{r}
# PCA
hgdp_pca <- hgdp_ldprune_gt %>% gt_pca_partialSVD()

library(ggplot2)
autoplot(hgdp_pca, type = "scores") +
  aes(color = hgdp_gt$region) +
  labs(color = "region")
```

## Population structure analysis - ADMIXTURE `tidypopgen`

Run ADMIXTURE through `tidypopgen`:
```{r}
# group by region for later plotting
hgdp_ldprune_gt <- hgdp_ldprune_gt %>% group_by(region)

# run ADMIXTURE for k = 2-7 and 1 repeat to get an idea of the best k  ## DOESNT DIP TILL K=14
hgdp_adm_cv <- hgdp_ldprune_gt %>% 
  gt_admixture(k = 2:7, n_runs = 1, crossval = TRUE, 
               n_cores = 2, seed = 123, conda_env = "none")
```

Check `gt_admix` results object:
```{r}
# summarise the admixture results
hgdp_adm_cv_ %>% summary()
```

Plot the cross-validation:
```{r}
# plot the CV
hgdp_adm_cv_ %>% autoplot()
```

Barplot for single run:
```{r}
# plot barplot for given k and run using the groupings inherited from the grouped tibble
hgdp_adm_cv_ %>% autoplot(type = "barplot", k = 7, run = 1)
```

Save `gt_admix` for plotting with `clumpplingr`:
```{r}
# save results 
hgdp_adm_cv_ %>% saveRDS("../../hgdp_data/clustering/hgdp_admixture.rds")
```


##  Population structure analysis - fastmixture `fastmixturer`

```{r}
# run fastmixture for k = 2:5 and 5 runs -> or however many want to showcase clumppling visualisations
hgdp_fastm <- hgdp_ldprune_gt %>% 
  gt_fastmixture(k = c(2:5), n_repeats = 5, threads = 2,
                 seed = c(123,234,345,456,567))
```

Check `gt_admix` results object:
```{r}
# summarise the fastmixture results
hgdp_fastm %>% summary()
```

Barplot for single run:
```{r}
# plot barplot for given k and run using the groupings inherited from the grouped tibble:
hgdp_fastm %>% autoplot(type = "barplot", k = 7, run = 1) #DONT HAVE GROUPING IN FASTMIXTURE YET
```

Save `gt_admix` for plotting with `clumpplingr`:
```{r}
# save results
hgdp_fastm %>% saveRDS("../../hgdp_data/clustering/hgdp_fastmixture.rds")
```









