---
title: "Fastmixture vignette"
output: html_document
date: "2024-09-26"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Create gen_tibble

We will explore the genetic structure of *Anolis punctatus* in South America,
using data from Prates et al 2018. We downloaded the vcf file of the genotypes
from "https://github.com/ivanprates/2018_Anolis_EcolEvol/blob/master/data/VCFtools_SNMF_punctatus_t70_s10_n46/punctatus_t70_s10_n46_filtered.recode.vcf?raw=true" and compressed it to a vcf.gz file.

fastmixture in tidygenclust can take a path to a plink binary .bed file as an 
input, but in this case we read the data into tidypopgen's gen_tibble object 
from a compressed vcf with:

```{r}
library(tidypopgen)
vcf_path <- "../data/punctatus_t70_s10_n46_filtered.recode.vcf.gz"
anole_gt <- gen_tibble(vcf_path, quiet = TRUE, backingfile = tempfile("anolis_"))
```

## Add metadata

Population metadata can be found from another file on the github repository ("https://github.com/ivanprates/2018_Anolis_EcolEvol/raw/master/data/plot_order_punctatus_n46.csv).
Then we can add the population information:

```{r}
pops_path <- "../data/plot_order_punctatus_n46.csv"
pops <- readr::read_csv(pops_path)
anole_gt <- anole_gt %>% mutate(id = gsub('punc_',"",.data$id,))
anole_gt <- anole_gt %>% mutate(population = pops$pop[match(pops$ID,.data$id)])
anole_gt
```

## Impute missing and run PCA

We can now impute missing data and perform a PCA to explore the structure of the data.


```{r}
anole_gt <- gt_impute_simple(anole_gt, method = "mode")
anole_pca <- anole_gt %>% gt_pca_partialSVD(k=30)

library(ggplot2)
autoplot(anole_pca, type = "scores") +
  aes(color = anole_gt$population) +
  labs(color = "population")
```

The PCA plot indicates three major clusters in the anolis population.


## Running fastmixture 

We now run fastmixture for a series of K values simultaneously. The output object is a list of Q matrices that then we can use for downstream plotting/ analyses. The function `fastmixture_k_list` has an argument `save_q`, that if TRUE, saves the Q matrices in a specified directory. This is useful for then running clumpling and plotting.


```{r}
library(tidygenclust)

k <- c(2:3)

source("../R/fastmixture_k_list.R")

anole_qmat <- fastmixture_k_list(anole_gt, k, threads=1, seed=42,
                        iter=1000, tole=0.5,
                        batches=32, supervised=NULL, check=5, power=11,
                        chunk=8192, als_iter=1000, als_tole=1e-4,
                        no_freqs=TRUE, random_init=TRUE, save_q=T,
                        output_path = "../data/anole_q/")
```
Now you can index the list to inspect your q matrices
```{r}
anole_qmat[2]
```
## Run clumppling and plot

Now we can directly move to the clumpling vignette and run it for anolis. It is called `overview.RData` You can run the vignette exactly in the same manner, just changing the input path.

```{r}

input_path <- "../data/anole_q/"
clump_res <-clumppling(input_path = input_path)
```
